<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DataJam Install Tracker</title>
    <!-- v2.1 - Navigation fix deployed -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/installation/style.css?v=2.1">
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="logo">
                <img src="/installation/logo-gradient.png" alt="DataJam" class="logo-image">
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="active">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Dashboard
                </a>
                <a href="/installation/index.html" id="sidebarNewInstall">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    New Install
                </a>
                <a href="installations.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                    View Installs
                </a>
                <a href="inventory.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2"/>
                        <path d="M16 3h2a2 2 0 0 1 2 2v2M8 3H6a2 2 0 0 0-2 2v2"/>
                        <line x1="12" y1="11" x2="12" y2="17"/>
                        <line x1="9" y1="14" x2="15" y2="14"/>
                    </svg>
                    Inventory
                </a>
                <a href="projects.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    Projects
                </a>
                <a href="users.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Users
                </a>
                <a href="settings.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
                    </svg>
                    Settings
                </a>
                <a href="help.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Help Guide
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="currentUserName">User</div>
                        <div class="user-role" id="currentUserRole">Loading...</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="SessionManager.logout()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div style="margin-bottom: 32px;">
                <h1>Dashboard</h1>
                <p class="subtitle">Overview of your installation activity</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <a href="installations.html" class="stat-card stat-card-link">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #E62F6E 0%, #E94B52 100%);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalInstalls">0</div>
                        <div class="stat-label">Total Installations</div>
                    </div>
                </a>

                <a href="inventory.html" class="stat-card stat-card-link">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #E94B52 0%, #FF6B35 100%);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalJamboxes">0</div>
                        <div class="stat-label">JamBoxes Registered</div>
                        <div class="stat-breakdown" id="jamboxBreakdown" style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;"></div>
                    </div>
                </a>

                <a href="projects.html" class="stat-card stat-card-link">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #FF6B35 0%, #FFA500 100%);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="activeProjects">0</div>
                        <div class="stat-label">Active Projects</div>
                    </div>
                </a>

                <a href="installations.html" class="stat-card stat-card-link">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="recentInstalls">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                </a>
            </div>

            <!-- Quick Actions -->
            <div style="margin-top: 40px; margin-bottom: 32px;">
                <h2 style="font-size: 20px; font-weight: 500; margin-bottom: 16px; color: var(--datajam-pink);">Quick Actions</h2>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <a href="/installation/index.html" id="quickActionNewInstall" class="btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        New Installation
                    </a>
                    <a href="installations.html" class="btn-secondary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        </svg>
                        View All Installs
                    </a>
                    <a href="projects.html" class="btn-secondary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        View Projects
                    </a>
                </div>
            </div>

            <!-- Analytics Charts -->
            <div style="margin-top: 40px;">
                <h2 style="font-size: 20px; font-weight: 500; margin-bottom: 16px; color: var(--datajam-pink);">Analytics</h2>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Installations Over Time</h3>
                        <canvas id="installationsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Status Breakdown</h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Installations -->
            <div style="margin-top: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="font-size: 20px; font-weight: 500; color: var(--datajam-pink);">Recent Installations</h2>
                    <a href="installations.html" style="color: var(--datajam-orange); text-decoration: none; font-size: 14px; font-weight: 500;">
                        View All →
                    </a>
                </div>
                <div id="recentInstallsList" class="recent-installs-list">
                    <!-- Recent installations will be rendered here -->
                </div>
            </div>

            <!-- Storage Usage -->
            <div style="margin-top: 40px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);">
                <h2 style="font-size: 18px; font-weight: 500; margin-bottom: 12px; color: var(--datajam-pink);">Storage Usage</h2>
                <div id="storageInfo" style="color: var(--text-secondary); font-size: 14px;">
                    Calculating...
                </div>
                <div style="margin-top: 12px; height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden;">
                    <div id="storageBar" style="height: 100%; background: linear-gradient(135deg, #E62F6E 0%, #E94B52 100%); width: 0%; transition: width 0.3s ease;"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/installation/config.js"></script>
    <script src="/installation/supabase-client.js"></script>
    <script src="/installation/app.js"></script>
    <script>
        // Dashboard functionality
        class DashboardManager {
            constructor() {
                this.installations = this.loadInstallations();
                this.init();
            }

            loadInstallations() {
                try {
                    const data = localStorage.getItem('datajam_installations');
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    console.error('Error loading installations:', error);
                    return [];
                }
            }

            init() {
                // Initial render with localStorage data (for instant display)
                this.calculateStats();
                this.renderRecentInstalls();
                this.calculateStorage();

                // Load from Supabase in background (will update UI when data arrives)
                this.loadFromSupabase().then(loaded => {
                    if (loaded) {
                        // Re-render UI with cloud data
                        this.calculateStats();
                        this.renderRecentInstalls();
                        console.log('[Dashboard] UI refreshed with Supabase data');
                    }
                });
            }

            async loadFromSupabase() {
                if (typeof db === 'undefined') {
                    console.log('[Dashboard] Supabase not available, using localStorage');
                    return false;
                }

                try {
                    // Wait for db to be initialized
                    if (!db.initialized) {
                        await db.init();
                    }

                    console.log('[Dashboard] Loading installations from Supabase...');
                    const cloudInstallations = await db.getInstallations();

                    if (cloudInstallations && cloudInstallations.length > 0) {
                        // Normalize field names from Supabase (snake_case to camelCase)
                        this.installations = cloudInstallations.map(install => ({
                            id: install.id,
                            timestamp: install.created_at || install.timestamp,
                            status: install.status || 'completed',
                            projectName: install.project_name || install.projectName || '',
                            clientName: install.venue_name || install.clientName || '',
                            clientContact: install.contact_name || install.clientContact || '',
                            clientEmail: install.contact_email || install.clientEmail || '',
                            clientPhone: install.contact_phone || install.clientPhone || '',
                            locationType: install.location_type || install.locationType || '',
                            installAddress: install.address || install.installAddress || '',
                            jamboxId: install.jambox_id || install.jamboxId || '',
                            ssid: install.wifi_ssid || install.ssid || '',
                            password: install.wifi_password || install.password || '',
                            ipAddress: install.ip_address || install.ipAddress || '',
                            installDate: install.install_date || install.installDate || '',
                            installTime: install.install_time || install.installTime || '',
                            notes: install.notes || '',
                            deviceTested: install.device_tested ?? install.deviceTested ?? false,
                            networkVerified: install.network_verified ?? install.networkVerified ?? false,
                            photos: install.photos || []
                        }));

                        // Update localStorage cache
                        localStorage.setItem('datajam_installations', JSON.stringify(this.installations));
                        console.log('[Dashboard] Loaded', this.installations.length, 'installations from Supabase');
                        return true;
                    }
                } catch (err) {
                    console.error('[Dashboard] Failed to load from Supabase:', err);
                }

                return false;
            }

            calculateStats() {
                const total = this.installations.length;

                // Load JamBox registry for status breakdown
                const registry = this.loadJamboxRegistry();
                const totalRegistered = registry.length;

                // Count by status
                const inStock = registry.filter(jb => jb.status === 'in_stock').length;
                const shipped = registry.filter(jb => jb.status === 'shipped').length;
                const installed = registry.filter(jb => jb.status === 'installed' || jb.status === 'active').length;
                const faulty = registry.filter(jb => jb.status === 'faulty').length;

                // Count active projects (unique projects with installations)
                const projects = new Set(
                    this.installations
                        .filter(i => i.projectName)
                        .map(i => i.projectName)
                );
                const activeProjects = projects.size;

                // Count installations this week
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const thisWeek = this.installations.filter(i => {
                    const installDate = new Date(i.timestamp);
                    return installDate >= oneWeekAgo;
                }).length;

                // Update DOM
                document.getElementById('totalInstalls').textContent = total;
                document.getElementById('totalJamboxes').textContent = totalRegistered;
                document.getElementById('activeProjects').textContent = activeProjects;
                document.getElementById('recentInstalls').textContent = thisWeek;

                // Show JamBox breakdown if registry has data
                const breakdownEl = document.getElementById('jamboxBreakdown');
                if (breakdownEl) {
                    if (totalRegistered > 0) {
                        const parts = [];
                        if (inStock > 0) parts.push(`<span style="color: #6B7280;">${inStock} stock</span>`);
                        if (shipped > 0) parts.push(`<span style="color: #F59E0B;">${shipped} shipped</span>`);
                        if (installed > 0) parts.push(`<span style="color: #14B8A6;">${installed} installed</span>`);
                        if (faulty > 0) parts.push(`<span style="color: #E62F6E;">${faulty} faulty</span>`);
                        breakdownEl.innerHTML = parts.join(' | ');
                    } else {
                        breakdownEl.innerHTML = '<span style="opacity: 0.5;">No JamBoxes in registry</span>';
                    }
                }
            }

            loadJamboxRegistry() {
                try {
                    const data = localStorage.getItem('datajam_jambox_registry');
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    console.error('Error loading JamBox registry:', error);
                    return [];
                }
            }

            renderRecentInstalls() {
                const container = document.getElementById('recentInstallsList');

                if (this.installations.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 16px; opacity: 0.3;">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            </svg>
                            <p>No installations yet</p>
                            <a href="index.html" class="btn-primary" style="margin-top: 16px; display: inline-block; text-decoration: none;">Create First Installation</a>
                        </div>
                    `;
                    return;
                }

                // Sort by timestamp (most recent first) and take top 5
                const recent = [...this.installations]
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 5);

                container.innerHTML = recent.map(install => {
                    const date = new Date(install.timestamp);
                    const formattedDate = date.toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });

                    const status = install.status || 'completed';
                    const statusColors = {
                        'scheduled': '#4A90E2',
                        'in-progress': '#FFA500',
                        'completed': '#4ECDC4',
                        'issue': '#E62F6E'
                    };
                    const statusLabels = {
                        'scheduled': 'Scheduled',
                        'in-progress': 'In Progress',
                        'completed': 'Completed',
                        'issue': 'Issue/Problem'
                    };

                    return `
                        <div class="recent-install-item">
                            <div class="recent-install-header">
                                <div>
                                    <div class="recent-install-venue">${this.escapeHtml(install.clientName || 'Unnamed Venue')}</div>
                                    <div class="recent-install-meta">
                                        ${install.projectName ? `<span>${this.escapeHtml(install.projectName)}</span>` : ''}
                                        ${install.projectName && install.jamboxId ? '<span>•</span>' : ''}
                                        ${install.jamboxId ? `<span>JamBox: ${this.escapeHtml(install.jamboxId)}</span>` : ''}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="recent-install-date">${formattedDate}</div>
                                    <div class="status-badge" style="background-color: ${statusColors[status]}20; color: ${statusColors[status]}; margin-top: 4px;">
                                        ${statusLabels[status]}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            calculateStorage() {
                try {
                    const data = localStorage.getItem('datajam_installations') || '';
                    const sizeInBytes = new Blob([data]).size;
                    const sizeInKB = (sizeInBytes / 1024).toFixed(2);
                    const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);

                    // Estimate localStorage limit (usually 5-10MB, we'll use 5MB as conservative estimate)
                    const limitMB = 5;
                    const percentageUsed = (sizeInMB / limitMB) * 100;

                    const infoEl = document.getElementById('storageInfo');
                    const barEl = document.getElementById('storageBar');

                    if (sizeInMB >= 1) {
                        infoEl.textContent = `Using ${sizeInMB} MB of approximately ${limitMB} MB available`;
                    } else {
                        infoEl.textContent = `Using ${sizeInKB} KB of approximately ${limitMB} MB available`;
                    }

                    barEl.style.width = `${Math.min(percentageUsed, 100)}%`;

                    // Warning if over 80%
                    if (percentageUsed > 80) {
                        barEl.style.background = 'linear-gradient(135deg, #E62F6E 0%, #C41E3A 100%)';
                        infoEl.innerHTML += ' <span style="color: var(--datajam-pink); font-weight: 500;">⚠️ Storage almost full</span>';
                    }
                } catch (error) {
                    console.error('Error calculating storage:', error);
                    document.getElementById('storageInfo').textContent = 'Unable to calculate storage usage';
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize dashboard
        const dashboardManager = new DashboardManager();

        // Populate user info in sidebar
        document.addEventListener('DOMContentLoaded', () => {
            const userNameEl = document.getElementById('currentUserName');
            const userRoleEl = document.getElementById('currentUserRole');

            if (userNameEl && SessionManager) {
                userNameEl.textContent = SessionManager.getCurrentUser();
            }
            if (userRoleEl && SessionManager) {
                const role = SessionManager.getUserRole() || 'user';
                userRoleEl.textContent = role;
            }

            // Fix navigation for New Install links - use absolute path to bypass Netlify's Pretty URLs
            document.querySelectorAll('a[href*="index.html"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('[Dashboard] Navigating to /installation/index.html');
                    window.location.href = '/installation/index.html';
                });
            });
        });
    </script>
</body>
</html>
