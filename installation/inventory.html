<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management - DataJam</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <style>
        /* Hide content until admin check passes */
        .app-layout { opacity: 0; transition: opacity 0.2s ease; }
        .app-layout.authorized { opacity: 1; }
        .admin-gate-loading {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-primary, #0A0C11);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .admin-gate-loading.hidden { display: none; }
    </style>
</head>
<body>
    <!-- Loading overlay - hidden once authorized -->
    <div class="admin-gate-loading" id="adminGate">
        <div style="text-align: center; color: #888;">
            <div style="font-size: 24px; margin-bottom: 8px;">üîê</div>
            <div>Checking access...</div>
        </div>
    </div>

    <div class="app-layout" id="appLayout">
        <aside class="sidebar">
            <div class="logo">
                <img src="logo-gradient.png" alt="DataJam" class="logo-image">
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Dashboard
                </a>
                <a href="index.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    New Install
                </a>
                <a href="installations.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                    View Installs
                </a>
                <a href="inventory.html" class="active">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2"/>
                        <path d="M16 3h2a2 2 0 0 1 2 2v2M8 3H6a2 2 0 0 0-2 2v2"/>
                        <line x1="12" y1="11" x2="12" y2="17"/>
                        <line x1="9" y1="14" x2="15" y2="14"/>
                    </svg>
                    Inventory
                </a>
                <a href="projects.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    Projects
                </a>
                <a href="users.html" class="admin-only">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Users
                </a>
                <a href="settings.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/>
                    </svg>
                    Settings
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="currentUserName">User</div>
                        <div class="user-role" id="currentUserRole">Loading...</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="SessionManager.logout()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 32px;">
                <div>
                    <h1>Inventory Management</h1>
                    <p class="subtitle">Track JamBox devices, cables, and equipment shipments</p>
                </div>
            </div>

            <!-- Current Stock Overview -->
            <div class="stats-grid" style="margin-bottom: 32px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #E62F6E 0%, #E94B52 100%);">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-content">
                        <div class="stat-label">JamBox Stock</div>
                        <div class="stat-value" id="jamboxStock">0</div>
                    </div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #E94B52 0%, #F59E0B 100%);">
                    <div class="stat-icon">üîå</div>
                    <div class="stat-content">
                        <div class="stat-label">Cable Stock</div>
                        <div class="stat-value" id="cableStock">0</div>
                    </div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #14B8A6 0%, #06B6D4 100%);">
                    <div class="stat-icon">üöö</div>
                    <div class="stat-content">
                        <div class="stat-label">Active Shipments</div>
                        <div class="stat-value" id="activeShipments">0</div>
                    </div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <div class="stat-label">Total Deployed</div>
                        <div class="stat-value" id="totalDeployed">0</div>
                    </div>
                </div>
            </div>

            <!-- Tabs for different sections -->
            <div class="inventory-tabs" style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid var(--border-color); padding-bottom: 0;">
                <button class="inventory-tab active" data-tab="stock">
                    üì¶ Stock Management
                </button>
                <button class="inventory-tab" data-tab="shipments">
                    üöö Active Shipments
                </button>
                <button class="inventory-tab" data-tab="delivered">
                    ‚úÖ Delivered
                </button>
                <button class="inventory-tab" data-tab="history">
                    üìú History
                </button>
            </div>

            <!-- Stock Management Section -->
            <div class="tab-content active" id="stockTab">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                    <!-- Add Stock Form -->
                    <div class="form-section">
                        <h2>Add Stock</h2>
                        <form id="addStockForm">
                            <div class="form-group">
                                <label for="stockType">Item Type *</label>
                                <select id="stockType" required>
                                    <option value="">Select item type</option>
                                    <option value="jambox">JamBox Device</option>
                                    <option value="cable">Cable</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="stockQuantity">Quantity *</label>
                                <input type="number" id="stockQuantity" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="stockNotes">Notes</label>
                                <textarea id="stockNotes" rows="3" placeholder="Purchase order, supplier, etc."></textarea>
                            </div>
                            <button type="submit" class="btn-primary">Add to Stock</button>
                        </form>
                    </div>

                    <!-- Remove Stock Form -->
                    <div class="form-section">
                        <h2>Remove Stock</h2>
                        <form id="removeStockForm">
                            <div class="form-group">
                                <label for="removeType">Item Type *</label>
                                <select id="removeType" required>
                                    <option value="">Select item type</option>
                                    <option value="jambox">JamBox Device</option>
                                    <option value="cable">Cable</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="removeQuantity">Quantity *</label>
                                <input type="number" id="removeQuantity" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="removeReason">Reason *</label>
                                <select id="removeReason" required>
                                    <option value="">Select reason</option>
                                    <option value="damaged">Damaged</option>
                                    <option value="lost">Lost</option>
                                    <option value="returned">Returned to Supplier</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="removeNotes">Notes</label>
                                <textarea id="removeNotes" rows="2" placeholder="Additional details"></textarea>
                            </div>
                            <button type="submit" class="btn-delete">Remove from Stock</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Shipments Section -->
            <div class="tab-content" id="shipmentsTab">
                <div class="form-section" style="margin-bottom: 32px;">
                    <h2>Create New Shipment</h2>
                    <form id="shipmentForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group" style="grid-column: span 2;">
                                <label for="shipDestination">Destination / Project *</label>
                                <select id="shipDestination" required>
                                    <option value="">Loading projects...</option>
                                </select>
                            </div>
                            <div class="form-group" id="customDestinationGroup" style="display: none; grid-column: span 2;">
                                <label for="customDestination">Custom Destination *</label>
                                <input type="text" id="customDestination" placeholder="Enter custom destination (e.g., Sports Revolution, Bauer Media)">
                            </div>
                            <div class="form-group">
                                <label for="shipDate">Shipment Date *</label>
                                <input type="date" id="shipDate" required>
                            </div>
                            <div class="form-group">
                                <label for="shipJamboxQty">JamBox Quantity</label>
                                <input type="number" id="shipJamboxQty" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="shipCableQty">Cable Quantity</label>
                                <input type="number" id="shipCableQty" min="0" value="0">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label for="shipNotes">Shipping Notes</label>
                                <textarea id="shipNotes" rows="3" placeholder="Tracking number, carrier, expected delivery, etc."></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">Create Shipment</button>
                    </form>
                </div>

                <h2 style="margin-bottom: 16px;">Active Shipments</h2>
                <div id="shipmentsGrid" class="install-grid">
                    <!-- Shipments will be rendered here -->
                </div>
            </div>

            <!-- Delivered Shipments Section -->
            <div class="tab-content" id="deliveredTab">
                <h2 style="margin-bottom: 16px;">Delivered Shipments</h2>
                <div id="deliveredGrid" class="install-grid">
                    <!-- Delivered shipments will be rendered here -->
                </div>
            </div>

            <!-- History Section -->
            <div class="tab-content" id="historyTab">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Stock Movement History</h2>
                    <div style="display: flex; gap: 12px;">
                        <button id="exportInventoryCSV" class="btn-secondary">Export CSV</button>
                        <button id="clearInventoryHistory" class="btn-delete">Clear History</button>
                    </div>
                </div>
                <div id="historyList">
                    <!-- History entries will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-client.js"></script>
    <script src="app.js"></script>
    <script>
        // Protect this page - admin only
        if (SessionManager && !SessionManager.isAdmin()) {
            window.location.href = 'dashboard.html';
        } else {
            // Admin authorized - show content
            document.getElementById('appLayout').classList.add('authorized');
            document.getElementById('adminGate').classList.add('hidden');
        }

        // Populate user info in sidebar and shipment destination dropdown
        document.addEventListener('DOMContentLoaded', () => {
            const userNameEl = document.getElementById('currentUserName');
            const userRoleEl = document.getElementById('currentUserRole');

            if (userNameEl && SessionManager) {
                userNameEl.textContent = SessionManager.getCurrentUser();
            }
            if (userRoleEl && SessionManager) {
                const role = SessionManager.getUserRole() || 'user';
                userRoleEl.textContent = role;
            }

            // Hide admin-only elements for non-admins (shouldn't reach here, but just in case)
            if (SessionManager && !SessionManager.isAdmin()) {
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'none';
                });
            }

            // Populate shipment destination dropdown from authorized projects
            const destSelect = document.getElementById('shipDestination');
            if (destSelect && SessionManager) {
                const projects = SessionManager.getProjects();
                console.log('[INVENTORY] Authorized projects:', projects);

                // Clear and rebuild dropdown
                destSelect.innerHTML = '<option value="">Select destination...</option>';

                if (projects && projects.length > 0) {
                    // Add authorized projects
                    projects.forEach(proj => {
                        const name = proj.project_name || proj.ProjectName || proj.name;
                        if (name) {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            destSelect.appendChild(option);
                        }
                    });

                    // Add separator and manual entry option
                    const separator = document.createElement('option');
                    separator.disabled = true;
                    separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                    destSelect.appendChild(separator);

                    const otherOption = document.createElement('option');
                    otherOption.value = '__custom__';
                    otherOption.textContent = 'Other (Custom)...';
                    destSelect.appendChild(otherOption);
                } else {
                    // No projects - allow manual entry
                    destSelect.innerHTML = `
                        <option value="">No authorized projects</option>
                        <option value="__custom__">Enter destination manually...</option>
                    `;
                }

                // Handle "Other" selection - show custom input
                destSelect.addEventListener('change', function() {
                    const customGroup = document.getElementById('customDestinationGroup');
                    const customInput = document.getElementById('customDestination');
                    if (this.value === '__custom__') {
                        customGroup.style.display = 'block';
                        customInput.required = true;
                    } else {
                        customGroup.style.display = 'none';
                        customInput.required = false;
                    }
                });
            }
        });
    </script>
</body>
</html>
